<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat">

<insert id="start" parameterType="chat">
<selectKey keyProperty="chatSeq" resultType="string" order="BEFORE">
  SELECT CHAT_SEQ.NEXTVAL FROM DUAL
</selectKey>
  INSERT INTO MSG (
    chat_seq,
    user_id,
    chat_div
  ) VALUES (
    #{chatSeq},
    #{userId},
    #{chatDiv}
  )

</insert>

<insert id="message" parameterType="chat">
INSERT INTO MSG_DETAIL (
  chat_seq,
  chat_div,
  chat_dt,
  chat_contents
) VALUES (
  #{chatSeq},
  #{chatDiv},
  SYSDATE,
  #{chatContents}
)
</insert>

<select id="selectMsgList" parameterType="chatDetail" resultType="chatDetail">
    SELECT
		    chat_seq,
		    chat_dt,
		    chat_contents
    FROM (
    SELECT
        MD.chat_seq,
        MD.chat_dt,
        MD.chat_contents,
        ROW_NUMBER() OVER(PARTITION BY MD.chat_seq ORDER BY MD.chat_dt) AS row_num
    FROM
        MSG_detail MD
    JOIN MSG M ON MD.chat_seq = M.chat_seq
    WHERE
        M.USER_ID = #{userId}
		) numbered
		WHERE row_num = 1
</select>

<select id="contentSelect" parameterType="chat" resultType="chatDetail">
  SELECT
  *
  FROM MSG_DETAIL
  WHERE CHAT_SEQ = #{chatSeq}
</select>


</mapper>

